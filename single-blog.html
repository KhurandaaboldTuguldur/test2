<!-- ✅ 필수 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  const slug = new URLSearchParams(window.location.search).get("slug");
  const wrapper = document.getElementById("post-wrapper");
  const yearEl = document.getElementById("year") || document.getElementById("copyrightYear");
  if (yearEl) yearEl.innerText = new Date().getFullYear();

  function showError(msg) {
    wrapper.innerHTML = `<p style="color:red">${msg} <a href="index.html">← 홈으로</a></p>`;
  }

  function formatDate(dateStr) {
    try {
      return new Date(dateStr).toLocaleDateString("ko-KR", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });
    } catch {
      return dateStr;
    }
  }

  function parseFrontmatter(md) {
    const match = md.match(/^---\s*([\s\S]*?)\s*---\s*([\s\S]*)$/);
    if (!match) return { data: {}, content: md };

    const raw = match[1];
    const content = match[2];
    const data = {};
    raw.split('\n').forEach(line => {
      const [key, ...rest] = line.split(':');
      if (key && rest.length > 0) {
        data[key.trim()] = rest.join(':').trim();
      }
    });
    return { data, content };
  }

  function renderPost(md) {
    if (typeof marked !== "function") {
      showError("❗ marked 라이브러리가 로드되지 않았습니다.");
      return;
    }

    const parsed = parseFrontmatter(md); // ✅ 대체된 parser
    const fm = parsed.data;
    const html = marked.parse(parsed.content);

    const rawThumb = (fm.thumbnail || "").replace(/^\/+|\/+$/g, "");
    const thumbnail = rawThumb.startsWith("http") ? rawThumb : "/" + rawThumb;

    wrapper.innerHTML = `
      <article class="blog-post">
        <h1>${fm.title || slug}</h1>
        ${fm.date ? `<p><em>${formatDate(fm.date)}</em></p>` : ""}
        ${fm.thumbnail ? `<img src="${thumbnail}" alt="썸네일" style="max-width:100%;margin:1rem 0;border-radius:8px;" />` : ""}
        <div class="post-content">${html}</div>
      </article>
    `;
  }

  function fetchPost(slug) {
    fetch(`./posts/${slug}.md`)
      .then(res => {
        if (!res.ok) throw new Error("❗ 포스트를 찾을 수 없습니다.");
        return res.text();
      })
      .then(renderPost)
      .catch(err => {
        console.error("⚠️", err);
        showError("🚫 해당 포스트를 불러올 수 없습니다. 파일 경로를 다시 확인하세요.");
      });
  }

  if (!slug) {
    showError("❗ URL에 slug 파라미터가 없습니다.");
  } else {
    fetchPost(slug);
  }
</script>
